helper-repack-iso-inject-reg-into-wim() { local arr_name="$1" wim_file="$2" wimmount="$3"; mkdir -p "$wimmount"; eval "local arr=(\"\${${arr_name}[@]}\")"; local image_count; image_count=$(wimlib-imagex info "$wim_file" | grep -i 'Image Count' | awk '{print $NF}'); for i in $(seq 1 "$image_count"); do wimlib-imagex mount "$wim_file" "$i" "$wimmount"; for entry in "${arr[@]}"; do local regfile="${entry%%,*}"; if [[ "$regfile" == //* ]]; then regfile=$(helper-repack-iso-mount-smb "$entry") || continue; fi; if [[ ! -f "$regfile" ]]; then echo "Warning: '$regfile' not found, skipping."; continue; fi; local reg_encoding; reg_encoding=$(file -bi "$regfile" | awk -F '=' '{print $2}'); local converted_reg="$regfile"; if [[ "$reg_encoding" == "utf-16le" || "$reg_encoding" == "utf-16be" ]]; then converted_reg="/tmp/converted.reg"; iconv -f "$reg_encoding" -t utf-8 < "$regfile" | dos2unix > "$converted_reg"; fi; for hive in SYSTEM SOFTWARE SAM SECURITY DEFAULT; do local hive_path="$wimmount/Windows/System32/config/$hive"; [[ -f "$hive_path" ]] && hivexregedit --merge --prefix "HKEY_LOCAL_MACHINE\\$hive" "$hive_path" "$converted_reg"; done; done; wimlib-imagex unmount "$wimmount" --commit; done; }