windows-setup-disk-configuration() { local disk_id=0 wipe_disk="false" create_args=() modify_args=() collecting_create=0 collecting_modify=0; while [[ $# -gt 0 ]]; do case "$1" in adddisk) [[ ${#create_args[@]} -gt 0 || ${#modify_args[@]} -gt 0 ]] && { echo -e "\t\t\t<DiskConfiguration>\n\t\t\t\t<Disk wcm:action=\"add\">\n\t\t\t\t\t<DiskID>$disk_id</DiskID>\n\t\t\t\t\t<WillWipeDisk>$wipe_disk</WillWipeDisk>"; [[ ${#create_args[@]} -gt 0 ]] && windows-setup-disk-configuration-createpartitions "${create_args[@]}"; [[ ${#modify_args[@]} -gt 0 ]] && windows-setup-disk-configuration-modifypartitions "${modify_args[@]}"; echo -e "\t\t\t\t</Disk>\n\t\t\t</DiskConfiguration>"; create_args=(); modify_args=(); ((disk_id++)); wipe_disk="false"; }; collecting_create=0; collecting_modify=0 ;; DiskID) shift; disk_id="$1" ;; WillWipeDisk) shift; wipe_disk="$1" ;; createpartitions) shift; collecting_create=1; collecting_modify=0; [[ "$1" == "EFI" ]] && create_args+=(add Order 3 Type Primary Size 500 add Order 1 Type EFI Size 500 add Order 2 Type MSR Size 128 add Order 4 Type Primary Extend true) && shift; [[ "$1" == "BIOS" ]] && create_args+=(add Order 1 Type Primary Size 500 add Extend true Order 2 Type Primary) && shift; while [[ $# -gt 0 && "$1" != "modifypartitions" && "$1" != "adddisk" ]]; do create_args+=("$1"); shift; done; continue ;; modifypartitions) shift; collecting_create=0; collecting_modify=1; [[ "$1" == "EFI" ]] && modify_args+=(add Order 3 PartitionID 3 Label WINRE Format NTFS TypeID "DE94BBA4-06D1-4D40-A16A-BFD50179D6AC" add Order 1 PartitionID 1 Label System Format FAT32 add Order 2 PartitionID 2 add Order 4 PartitionID 4 Label OS Letter C Format NTFS) && shift; [[ "$1" == "BIOS" ]] && modify_args+=(add Active true Format NTFS Label "System Reserved" Order 1 PartitionID 1 TypeID 0x27 add Active true Format NTFS Label OS Letter C Order 2 PartitionID 2) && shift; while [[ $# -gt 0 && "$1" != "createpartitions" && "$1" != "adddisk" ]]; do modify_args+=("$1"); shift; done; continue ;; add) [[ $collecting_create -eq 1 ]] && create_args+=(add); [[ $collecting_modify -eq 1 ]] && modify_args+=(add); ;; *) [[ $collecting_create -eq 1 ]] && create_args+=("$1"); [[ $collecting_modify -eq 1 ]] && modify_args+=("$1"); ;; esac; shift; done; [[ ${#create_args[@]} -gt 0 || ${#modify_args[@]} -gt 0 ]] && { echo -e "\t\t\t<DiskConfiguration>\n\t\t\t\t<Disk wcm:action=\"add\">\n\t\t\t\t\t<DiskID>$disk_id</DiskID>\n\t\t\t\t\t<WillWipeDisk>$wipe_disk</WillWipeDisk>"; [[ ${#create_args[@]} -gt 0 ]] && windows-setup-disk-configuration-createpartitions "${create_args[@]}"; [[ ${#modify_args[@]} -gt 0 ]] && windows-setup-disk-configuration-modifypartitions "${modify_args[@]}"; echo -e "\t\t\t\t</Disk>\n\t\t\t</DiskConfiguration>"; }; }